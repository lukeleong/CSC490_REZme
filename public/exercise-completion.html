<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Completion</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }

    table th, table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    table th {
        background-color: #f4f4f4;
    }

    form {
        margin-bottom: 20px;
    }

    input, button {
        padding: 8px;
        margin: 4px;
    }
</style>
</head>
<body>
<h1>Exercise Completion Tracker</h1>
<form id="completionForm">
    <label for="PlanId">Plan ID</label>
    <input type="number" id="PlanId" placeholder="Enter Plan ID" required>

    <label for="exerciseDropdown">Select Exercise</label>
    <select id="exerciseDropdown" required>
        <option value="" disabled selected>Select an exercise</option>
        <!-- Options populated dynamically -->
    </select>

    <label for="SetsCompleted">Sets Completed</label>
    <input type="number" id="SetsCompleted" placeholder="Enter Sets Completed">

    <label for="RepsCompleted">Reps Completed</label>
    <input type="number" id="RepsCompleted" placeholder="Enter Reps Completed">

    <label for="TimeTaken">Time Taken (seconds)</label>
    <input type="number" id="TimeTaken" placeholder="Enter Time Taken">

    <label for="DifficultyRating">Difficulty Rating</label>
    <input type="number" id="DifficultyRating" placeholder="Rate Difficulty (1-4)">

    <label for="ProgressFeedback">Progress Feedback</label>
    <textarea id="ProgressFeedback" placeholder="Write your feedback"></textarea>

    <button type="submit">Save</button>
</form>

<h2>Existing Records</h2>
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Plan ID</th>
        <th>Exercise ID</th>
        <th>Sets</th>
        <th>Reps</th>
        <th>Time</th>
        <th>Difficulty</th>
        <th>Feedback</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="recordsTable"></tbody>
</table>
<script>
    async function fetchCompletions() {
        const response = await fetch('/api/exercise-completion');
        console.log('Response status:', response.status);
        if (!response.ok) {
            console.error('Failed to fetch records. Response status:', response.status);
            return;
        }
        console.log('Fetching records...');
        const completions = await response.json();

        console.log('Fetched records:', completions);
        const table = document.getElementById('recordsTable');
        table.innerHTML = completions.map(c => `
                <tr>
                    <td>${c.CompletionId}</td>
                    <td>${c.PlanId}</td>
                    <td>${exerciseMap[c.ExerciseId] || `Exercise ID: ${c.ExerciseId}`}</td>

                    <td>${c.SetsCompleted}</td>
                    <td>${c.RepsCompleted}</td>
                    <td>${c.TimeTaken || 'N/A'}</td>
                    <td>${c.DifficultyRating || 'N/A'}</td>
                    <td>${c.ProgressFeedback || 'N/A'}</td>
                    <td>
                        <button onclick="window.location.href='/edit/${c.CompletionId}'">Edit</button>
                        <button onclick="deleteRecord(${c.CompletionId})">Delete</button>
                        <button onclick="window.location.href='/completed-exercises'">View Progress</button>

                    </td>
                </tr>
            `).join('');
    }

    document.getElementById('completionForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const data = {
            PlanId: document.getElementById('PlanId').value,
            ExerciseId: document.getElementById('exerciseDropdown').value,
            SetsCompleted: document.getElementById('SetsCompleted').value || 0,
            RepsCompleted: document.getElementById('RepsCompleted').value || 0,
            TimeTaken: document.getElementById('TimeTaken').value || null,
            DifficultyRating: document.getElementById('DifficultyRating').value || null,
            ProgressFeedback: document.getElementById('ProgressFeedback').value || null,
        };
        console.log('Submitting data:', data);
        const response = await fetch('/api/exercise-completion', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        if (response.ok) {
            console.log('Record added successfully');
            await fetchCompletions(); // Reload the table to show the new record
            document.getElementById('completionForm').reset(); // Clear form inputs
        } else {
            console.error('Failed to add record');
        }
    });

    async function editRecord(id) {
        // Fetch the current record data from the API
        const response = await fetch(`/api/exercise-completion/${id}`);
        const record = await response.json();

        // Populate the form fields with the fetched data
        document.getElementById('PlanId').value = record.PlanId;
        document.getElementById('ExerciseId').value = record.ExerciseId;
        document.getElementById('SetsCompleted').value = record.SetsCompleted;
        document.getElementById('RepsCompleted').value = record.RepsCompleted;
        document.getElementById('TimeTaken').value = record.TimeTaken || '';
        document.getElementById('DifficultyRating').value = record.DifficultyRating || '';
        document.getElementById('ProgressFeedback').value = record.ProgressFeedback || '';

        // Modify the submit behavior to handle the update
        const form = document.getElementById('completionForm');
        form.onsubmit = async (event) => {
            event.preventDefault();

            const updatedData = {
                PlanId: document.getElementById('PlanId').value,
                ExerciseId: document.getElementById('ExerciseId').value,
                SetsCompleted: document.getElementById('SetsCompleted').value || 0,
                RepsCompleted: document.getElementById('RepsCompleted').value || 0,
                TimeTaken: document.getElementById('TimeTaken').value || null,
                DifficultyRating: document.getElementById('DifficultyRating').value || null,
                ProgressFeedback: document.getElementById('ProgressFeedback').value || null,
            };

            // Send a PUT request to update the record
            await fetch(`/api/exercise-completion/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(updatedData),
            });

            // Reset the form behavior to normal and reload the table
            form.onsubmit = null; // Reset form to its original POST behavior
            form.reset(); // Clear the form fields
            await fetchCompletions(); // Reload all records
        };
    }

    async function deleteRecord(id) {
        if (confirm('Are you sure you want to delete this record?')) {
            const response = await fetch(`/api/exercise-completion/${id}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                console.log(`Record with ID ${id} deleted successfully.`);
                await fetchCompletions(); // Reload the table to remove the deleted record
            } else {
                console.error(`Failed to delete record with ID ${id}`);
            }
        }
    }

    let exerciseMap = {}; // To store ExerciseID -> ExerciseName mapping

  async function fetchExercisesMap() {
    const response = await fetch('/api/exercises'); // Fetch all exercises
    if (response.ok) {
        const exercises = await response.json();
        const dropdown = document.getElementById('exerciseDropdown');
        dropdown.innerHTML = '<option value="" disabled selected>Select an exercise</option>';

        // Build a map of ExerciseID to ExerciseName
        exercises.forEach(exercise => {
            exerciseMap[exercise.ExerciseId] = exercise.ExerciseName; // Populate exerciseMap

            // Populate the dropdown options
            const option = document.createElement('option');
            option.value = exercise.ExerciseId; // Use ExerciseId as value
            option.textContent = exercise.ExerciseName; // Display ExerciseName
            dropdown.appendChild(option);
        });

        console.log('Exercise map:', exerciseMap); // Log exerciseMap for debugging
    } else {
        console.error('Failed to fetch exercises');
    }
}


    document.addEventListener('DOMContentLoaded', () => {
        fetchExercisesMap();
        fetchCompletions(); // Load existing records

    });


    fetchCompletions(); // Load records on page load
</script>
</body>
</html>
