<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recovery Plan - Recovery App</title>
  <!-- Font Awesome Link -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Font Link -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-blue: #17a2b8;
      --primary-blue-dark: #0d6efd;
      --text-muted: #5a6a7d;
      --card-bg: rgba(255, 255, 255, 0.75);
      --modal-bg: rgba(0, 0, 0, 0.6);
      --button-bg: #17a2b8;
      --button-bg-hover: #0d6efd;
      --white: #ffffff;
    }

    body {
      font-family: 'Segoe UI', 'Nunito Sans', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.7;
      background-image: url('images/backgroundimage2.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height: 100vh;
      padding: 50px 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background: var(--card-bg);
      padding: 35px 40px;
      border-radius: 12px;
      backdrop-filter: blur(5px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.07);
    }

    h1 {
      color: var(--primary-blue);
      font-weight: 700;
      margin-bottom: 30px;
      font-size: 2.4rem;
      text-align: center;
    }

    h2 {
      color: #2c3e50;
      font-weight: 600;
      margin-top: 30px;
      margin-bottom: 15px;
      font-size: 1.6rem;
    }

    .plan-overview {
      background: var(--white);
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      border: 1px solid rgba(23, 162, 184, 0.2);
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .plan-overview:hover {
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      transform: translateY(-3px);
    }

    .progress-bar {
      width: 100%;
      height: 25px;
      background: rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      margin: 25px 0;
      overflow: hidden;
    }

    .progress {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-blue) 0%, #66bb6a 100%);
      border-radius: 8px;
      transition: width 0.6s ease-out;
      color: var(--white);
      font-size: 1rem;
    }

    .back-button {
      display: inline-block;
      padding: 10px 20px;
      background-color: transparent;
      border: 2px solid var(--primary-blue);
      color: var(--primary-blue);
      text-align: center;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .back-button:hover {
      background-color: var(--primary-blue);
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }

    .exercise {
      background: var(--white);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 15px;
      transition: box-shadow 0.3s ease;
    }

    .exercise:hover {
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    }

    .exercise h3 { margin-bottom: 10px; font-size: 1.3rem; }
    .exercise p { margin-bottom: 8px; color: var(--text-muted); }

    .section-divider {
      border: none;
      height: 1px;
      background: rgba(23, 162, 184, 0.3);
      margin: 20px 0;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .status-badge.active {
      background-color: #e6f4ea;
      color: #4caf50;
    }

    .status-badge.completed {
      background-color: #f1f3f5;
      color: #6c757d;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--primary-blue);
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--modal-bg);
      z-index: 1000;
      padding: 20px;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: var(--white);
      color: #2c3e50;
      max-width: 480px;
      width: 100%;
      margin: auto;
      padding: 30px 25px;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      position: relative;
      text-align: center;
    }

    .modal h3 {
      color: var(--primary-blue);
      font-size: 1.5rem;
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: var(--primary-blue);
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 5px;
      font-size: 1rem;
      margin-top: 5px;
    }

    .button-primary {
      padding: 10px 20px;
      background-color: var(--button-bg);
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-primary:hover {
      background-color: var(--button-bg-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .button-secondary {
      padding: 10px 20px;
      background-color: transparent;
      border: 2px solid var(--primary-blue);
      color: var(--primary-blue);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-secondary:hover {
      background-color: var(--primary-blue);
      color: var(--white);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .button-grey {
      padding: 10px 20px;
      background-color: #6c757d;
      color: var(--white);
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .button-grey:hover {
      background-color: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    @media (max-width: 600px) {
      .modal-content {
        max-width: 95%;
        padding: 20px;
      }
      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }
      .modal-buttons button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="loadingSpinner" class="spinner" style="display: none;"></div>
    <h2>Assigned Exercises</h2>
    <div class="plan-overview">
      <div class="page-header-nav">
        <a href="dashboard.html" class="back-button">← Back to Dashboard</a>
      </div>
      <h1 id="recoveryTitle">Recovery Plan</h1>
      <div id="planDetails">
        <h2>Plan Details</h2>
        <p><strong>Injury:</strong> <span id="injuryType">Loading...</span></p>
        <p><strong>Start Date:</strong> <span id="startDate">Loading...</span></p>
        <p style="display: none;"><strong>End Date:</strong> <span id="endDate"></span></p>
        <p><strong>Status:</strong> <span id="isActive" class="status-badge">Loading...</span></p>
      </div>
      <div class="progress-bar">
        <div id="progress" class="progress"></div>
      </div>
      <span id="progress-label" style="display: block; text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">Progress: 0%</span>
    </div>
    <hr class="section-divider">
    <div id="exercisesContainer">
      <p>Loading exercises...</p>
    </div>
  </div>

  <!-- Rating Modal -->
  <div id="ratingModal">
    <div class="modal-content">
      <h3>Rate Exercise</h3>
      <form id="ratingForm">
        <input type="hidden" id="ratingExerciseId">
        <div class="input-group">
          <label for="ratingValue">Rating (0–5):</label>
          <div>
            <input type="range" id="ratingValue" name="rating" min="0" max="5" step="0.5" value="0"
              oninput="document.getElementById('ratingDisplay').innerText = parseFloat(this.value).toFixed(1)">
            <span id="ratingDisplay">0.0</span>
          </div>
        </div>
        <div class="input-group">
          <label for="ratingComment">Comment (Optional):</label>
          <textarea id="ratingComment" name="comment" rows="3"></textarea>
        </div>
        <button type="submit" class="button button-primary" id="ratingSubmitButton">Submit Rating</button>
        <button type="button" class="button button-grey" onclick="closeRatingModal()">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Exercise Completion Modal -->
  <div id="exCompleteModal">
    <div class="modal-content">
      <h3>Log Set/Reps</h3>
      <form id="exerciseCompleteForm">
        <input type="hidden" id="feedbackExerciseId">
        <input type="hidden" id="feedbackPlanId">
        <div class="input-group">
          <label for="setsCompleted">Sets Completed:</label>
          <input type="number" id="setsCompleted" name="setsCompleted" required min="0">
        </div>
        <div class="input-group">
          <label for="repsCompleted">Reps Completed (per set):</label>
          <input type="number" id="repsCompleted" name="repsCompleted" required min="0">
        </div>
        <button type="submit" class="button button-primary" id="feedbackSubmitButton">Submit</button>
        <button type="button" class="button button-grey" onclick="closeExCompleteModal()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    const userId = getUserIdFromToken();

    function getUserIdFromToken() {
      const token = localStorage.getItem("token");
      if (!token) return null;
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt0.toString(16)).slice(-2);
        }).join(''));
        const payload = JSON.parse(jsonPayload);
        return payload.id || payload.user_id || payload.UserId;
      } catch(err) {
        console.error("Failed to decode token:", err);
        return null;
      }
    }

    async function fetchRecoveryPlan() {
      const spinner = document.getElementById("loadingSpinner");
      spinner.style.display = "block";
      const planId = new URLSearchParams(window.location.search).get("planId");
      if (!planId) {
        document.getElementById("recoveryTitle").innerText = "Error: Plan ID not found";
        document.getElementById("planDetails").innerHTML = "<p>Could not load plan details.</p>";
        document.getElementById("exercisesContainer").innerHTML = "";
        spinner.style.display = "none";
        return;
      }

      try {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem("token");
        if (token) { headers['Authorization'] = `Bearer ${token}`; }

        const res = await fetch(`/api/recovery-plans/${planId}`, { headers });
        if (!res.ok) {
          if (res.status === 404) throw new Error("Plan not found.");
          if (res.status === 401) throw new Error("Unauthorized. Please log in.");
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        const plan = await res.json();

        if (!plan) throw new Error("Invalid plan data received.");

        const injuryTypeText = plan.Injury?.InjuryType || "General";
        document.getElementById("injuryType").innerText = injuryTypeText;
        document.getElementById("recoveryTitle").innerText = `Recovery Plan – ${injuryTypeText}`;
        document.getElementById("startDate").innerText = plan.StartDate ? new Date(plan.StartDate).toLocaleDateString() : 'N/A';

        const endDateEl = document.getElementById("endDate");
        const endDateParent = endDateEl.parentElement;
        if (plan.IsActive) {
          endDateParent.style.display = "none";
        } else {
          endDateParent.style.display = "block";
          endDateEl.innerText = plan.EndDate ? new Date(plan.EndDate).toLocaleDateString() : "Not set";
        }
        const isActiveSpan = document.getElementById("isActive");
        isActiveSpan.innerText = plan.IsActive ? "Active" : "Completed";
        isActiveSpan.className = "status-badge " + (plan.IsActive ? "active" : "completed");

        const progress = document.getElementById("progress");
        const progressPercentage = (plan.ProgressStatus !== null && plan.ProgressStatus !== undefined) ? parseInt(plan.ProgressStatus, 10) : 0;
        progress.style.width = `${progressPercentage}%`;
        progress.innerText = '';
        document.getElementById("progress-label").innerText = `Progress: ${progressPercentage}%`;

        fetchExercises(planId, headers);
      } catch (error) {
        console.error("Failed to fetch recovery plan:", error);
        document.getElementById("recoveryTitle").innerText = "Error Loading Plan";
        document.getElementById("planDetails").innerHTML = `<p style="color: var(--logout-red);">${error.message || "Could not load plan details."}</p>`;
        document.getElementById("exercisesContainer").innerHTML = "";
      } finally {
        spinner.style.display = "none";
      }
    }

    async function fetchExercises(planId, headers) {
      const container = document.getElementById("exercisesContainer");
      container.innerHTML = "<p>Loading exercises...</p>";

      try {
        const res = await fetch(`/api/recovery-plans/${planId}/exercises`, { headers });
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const exercises = await res.json();

        container.innerHTML = "";

        if (!exercises || !Array.isArray(exercises) || exercises.length === 0) {
          container.innerHTML = "<p>No exercises assigned to this recovery plan yet.</p>";
          return;
        }

        for (const ex of exercises) {
          let userRating = null;
          let avgRatingText = "No ratings";
          try {
            const ratingsRes = await fetch(`/api/exercise-ratings/exercise/${ex.ExerciseId}`, { headers });
            if (ratingsRes.ok) {
              const allRatings = await ratingsRes.json();
              if (Array.isArray(allRatings)) {
                userRating = allRatings.find(r => r.UserId === userId);
                if (allRatings.length > 0) {
                  const avg = (allRatings.reduce((sum, r) => sum + parseFloat(r.Rating || 0), 0) / allRatings.length);
                  avgRatingText = `Avg: ${avg.toFixed(1)}★`;
                }
              }
            }
          } catch (ratingError) {
            console.warn(`Could not fetch ratings for exercise ${ex.ExerciseId}:`, ratingError);
          }

          const div = document.createElement("div");
          div.className = "exercise";

          const ratingLinkOrText = avgRatingText === "No ratings"
            ? avgRatingText
            : `<a href="exercise-rating.html?exerciseId=${ex.ExerciseId}" style="text-decoration:none;" title="View all ratings">${avgRatingText}</a>`;

          const rateButtonClass = userRating ? "rate-btn rated" : "rate-btn";
          const rateButtonText = userRating ? "Change Rating" : "Rate";

          div.innerHTML = `
            <h3>${ex.ExerciseName || 'Unnamed Exercise'} <small style="font-weight:normal;">(${ratingLinkOrText})</small></h3>
            <p><strong>Target:</strong> ${ex.TargetMuscleGroup || 'N/A'}</p>
            <p><strong>Equipment:</strong> ${ex.Equipment || 'Body Weight'}</p>
            ${ex.VideoGuide ? `<p><a href="${ex.VideoGuide}" target="_blank" class="button button-secondary" style="padding: 5px 10px; font-size: 0.8rem;">Watch Guide <i class="fas fa-external-link-alt"></i></a></p>` : ""}
            <button class="button button-primary complete-btn" onclick="markExerciseComplete(${ex.ExerciseId}, ${planId})">Log Set/Reps</button>
            <button class="button ${rateButtonClass}" onclick="openRatingModal(${ex.ExerciseId})">${rateButtonText}</button>
          `;
          container.appendChild(div);
        }
      } catch (error) {
        console.error("Failed to fetch exercises:", error);
        container.innerHTML = `<p style="color: var(--logout-red);">Error loading exercises.</p>`;
      }
    }

    async function markExerciseComplete(exerciseId, planId) {
      document.getElementById("setsCompleted").value = '';
      document.getElementById("repsCompleted").value = '';
      document.getElementById("feedbackExerciseId").value = exerciseId;
      document.getElementById("feedbackPlanId").value = planId;
      document.getElementById("exCompleteModal").style.display = "block";
    }

    async function openRatingModal(exerciseId) {
      document.getElementById("ratingExerciseId").value = exerciseId;
      const ratingSlider = document.getElementById("ratingValue");
      const ratingDisplay = document.getElementById("ratingDisplay");
      const commentBox = document.getElementById("ratingComment");
      const submitBtn = document.getElementById("ratingSubmitButton");
      const heading = document.querySelector("#ratingModal .modal-content h3");

      ratingSlider.value = 0;
      ratingDisplay.innerText = "0.0";
      commentBox.value = "";
      submitBtn.innerText = "Submit Rating";
      submitBtn.className = "button button-primary";
      heading.innerText = "Rate Exercise";

      document.getElementById("ratingModal").style.display = "block";

      if (!userId) return;

      try {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem("token");
        if (token) { headers['Authorization'] = `Bearer ${token}`; }

        const res = await fetch(`/api/exercise-ratings/${exerciseId}/${userId}`, { headers });

        if (res.ok) {
          const userRating = await res.json();
          if (userRating && userRating.Rating !== undefined) {
            ratingSlider.value = userRating.Rating;
            ratingDisplay.innerText = parseFloat(userRating.Rating).toFixed(1);
            commentBox.value = userRating.Comment || "";
            submitBtn.innerText = "Update Rating";
            submitBtn.className = "button button-secondary";
            heading.innerText = "Update Rating";
          }
        } else if (res.status !== 404) {
          console.warn(`Could not preload rating: ${res.statusText}`);
        }
      } catch (err) {
        console.error("Error preloading rating:", err);
      }
    }

    function closeRatingModal() {
      document.getElementById("ratingModal").style.display = "none";
    }

    function closeExCompleteModal() {
      document.getElementById("exCompleteModal").style.display = "none";
    }

    document.getElementById("ratingForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      console.log("--- Rating Form Submit Start ---");

      if (!userId) {
        alert("Please log in to rate.");
        console.log("Rating aborted: User not logged in.");
        return;
      }

      const exerciseId = document.getElementById("ratingExerciseId").value;
      const rating = parseFloat(document.getElementById("ratingValue").value);
      const comment = document.getElementById("ratingComment").value;
      const submitBtn = document.getElementById("ratingSubmitButton");
      const originalBtnText = submitBtn.innerText;

      console.log("Form Data:", { exerciseId, rating, comment, userId });

      if (isNaN(rating) || rating < 0 || rating > 5) {
        alert("Invalid rating value.");
        console.log("Rating aborted: Invalid rating value.");
        return;
      }
      if (!exerciseId) {
        alert("Error: Exercise ID is missing.");
        console.log("Rating aborted: Exercise ID is missing.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerText = "Saving...";
      console.log("Submit button disabled, text set to 'Saving...'.");

      const payload = { Rating: rating, Comment: comment };
      console.log("Initial payload (for body):", payload);

      try {
        let method = "POST";
        let endpoint = "/api/exercise-ratings";
        let finalPayload = { userId: userId, exerciseId: parseInt(exerciseId, 10), ...payload };

        console.log("Checking if rating exists...");
        try {
          const headers = { 'Content-Type': 'application/json' };
          const token = localStorage.getItem("token");
          if (token) { headers['Authorization'] = `Bearer ${token}`; }

          const checkEndpoint = `/api/exercise-ratings/${exerciseId}/${userId}`;
          console.log("Checking existing rating at:", checkEndpoint);
          const checkRes = await fetch(checkEndpoint, { headers });

          console.log("Check response status:", checkRes.status);
          if (checkRes.ok) {
            method = "PUT";
            endpoint = checkEndpoint;
            finalPayload = payload;
            console.log("Rating exists. Method set to PUT, endpoint:", endpoint);
          } else if (checkRes.status === 404) {
            console.log("Rating does not exist. Method remains POST, endpoint:", endpoint);
          } else {
            console.warn(`Rating check unexpected status: ${checkRes.status}`);
          }
        } catch (checkErr) {
          console.error("Error checking existing rating:", checkErr);
        }

        console.log(`Preparing ${method} request to ${endpoint}`);
        console.log("Final payload for request body:", finalPayload);

        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem("token");
        if (token) { headers['Authorization'] = `Bearer ${token}`; }

        const res = await fetch(endpoint, {
          method: method,
          headers: headers,
          body: JSON.stringify(finalPayload)
        });

        console.log("Fetch response received. Status:", res.status);

        const contentType = res.headers.get("content-type");
        let result = null;
        let responseText = await res.text();

        if (contentType && contentType.indexOf("application/json") !== -1) {
          try {
            result = JSON.parse(responseText);
            console.log("Response JSON:", result);
          } catch (parseError) {
            console.error("Error parsing JSON response:", parseError);
            result = { error: "Failed to parse server response." };
          }
        } else {
          console.log("Response Text (Non-JSON):", responseText);
          if (!res.ok) {
            result = { error: `Server responded with status: ${res.status}. Response: ${responseText}` };
          } else {
            console.log("Successful non-JSON response.");
          }
        }

        if (res.ok) {
          console.log("Request successful (status OK). Closing modal and refreshing.");
          closeRatingModal();
          fetchRecoveryPlan();
        } else {
          const errorMsg = result?.error || result?.message || `Failed to save rating (Status: ${res.status})`;
          alert(errorMsg);
          console.error("Rating save error:", errorMsg, result);
        }
      } catch (err) {
        console.error("General error during rating submission:", err);
        alert("Something went wrong saving the rating. Check console for details.");
      } finally {
        console.log("Rating submission finally block. Enabling button.");
        submitBtn.disabled = false;
        submitBtn.innerText = originalBtnText;
        console.log("Submit button re-enabled.");
      }
    });

    document.getElementById("exerciseCompleteForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!userId) { alert("Please log in."); return; }

      const exerciseId = document.getElementById("feedbackExerciseId").value;
      const planId = document.getElementById("feedbackPlanId").value;
      const setsCompleted = parseInt(document.getElementById("setsCompleted").value);
      const repsCompleted = parseInt(document.getElementById("repsCompleted").value);
      const submitBtn = document.getElementById("feedbackSubmitButton");
      const originalBtnText = submitBtn.innerText;

      if (isNaN(setsCompleted) || setsCompleted < 0 || isNaN(repsCompleted) || repsCompleted < 0) {
        alert("Please enter valid numbers for sets and reps.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerText = "Submitting...";

      const payload = {
        PlanId: parseInt(planId, 10),
        ExerciseId: parseInt(exerciseId, 10),
        SetsCompleted: setsCompleted,
        RepsCompleted: repsCompleted,
        UserId: userId
      };

      try {
        const headers = { 'Content-Type': 'application/json' };
        const token = localStorage.getItem("token");
        if (token) { headers['Authorization'] = `Bearer ${token}`; }

        const res = await fetch("/api/exercise-completions", {
          method: "POST",
          headers: headers,
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (res.ok) {
          closeExCompleteModal();
          fetchRecoveryPlan();
        } else {
          alert(result.error || "Failed to save exercise completion data.");
          console.error("Completion save error:", result);
        }
      } catch (err) {
        console.error("Error saving exercise completion data:", err);
        alert("Something went wrong saving completion data.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerText = "Submit";
      }
    });

    fetchRecoveryPlan();
  </script>
</body>

</html>