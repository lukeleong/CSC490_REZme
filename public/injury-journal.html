<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Injury Journal</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      h1 {
        text-align: center;
      }
      .input-group {
        margin: 15px 0;
      }
      .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .input-group input,
      .input-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .button {
        background: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        cursor: pointer;
      }
      .journal-entry {
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fff;
        padding: 15px;
        margin-bottom: 15px;
      }
      #feedback {
        margin: 15px 0;
        padding: 10px;
      }
      .range-display {
        font-weight: bold;
        margin-left: 10px;
      }
      .injury-summary {
        margin-bottom: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #e9ecef;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="dashboard.html" class="button" style="margin-bottom: 20px; display: inline-block;">Back to Dashboard</a>
      <h1>Injury Journal</h1>
      
      <!-- Injury summary and hidden input -->
      <div id="injurySummary" class="injury-summary">
        <p>Loading injury details...</p>
      </div>
      <!-- Hidden input to store injuryId -->
      <input type="hidden" id="injuryId" name="injuryId" />

      <form id="journalForm">
        <div class="input-group">
          <label for="painLevel">Pain Level (1-10)</label>
          <input type="range" id="painLevel" name="painLevel" min="1" max="10" value="5" oninput="document.getElementById('painDisplay').innerText = this.value" />
          <span id="painDisplay" class="range-display">5</span>
        </div>
        <div class="input-group">
          <label for="mobilityLevel">Mobility Level (1-10)</label>
          <input type="range" id="mobilityLevel" name="mobilityLevel" min="1" max="10" value="5" oninput="document.getElementById('mobilityDisplay').innerText = this.value" />
          <span id="mobilityDisplay" class="range-display">5</span>
        </div>
        <div class="input-group">
          <label for="progressNotes">Journal / Progress Notes</label>
          <textarea id="progressNotes" name="progressNotes" rows="5" placeholder="How are you feeling? Any observations?"></textarea>
        </div>
        <button type="submit" class="button">Submit Journal Entry</button>
      </form>
      
      <div id="feedback"></div>
      
      <h2>Your Journal Entries</h2>
      <div id="journalEntries">
        <p>Loading journal entries...</p>
      </div>
    </div>

    <script>
      // Helper: get user id from token stored in localStorage
      function getUserIdFromToken() {
        const token = localStorage.getItem("token");
        if (!token) return null;
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.id || payload.UserId || payload.user_id;
        } catch (err) {
          console.error("Failed to decode token:", err);
          return null;
        }
      }

      // Helper: get query parameter from URL
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      // Fetch injury details for the given injury id and populate the summary and hidden input
      async function fetchInjuryDetail() {
        const injuryId = getQueryParam("injury_id");
        const userId = getUserIdFromToken();
        if (!injuryId || !userId) {
          document.getElementById("injurySummary").innerHTML = "<p>Error: Injury not specified or user not logged in.</p>";
          return;
        }
        // Option 1: If your API supports fetching a single injury by ID:
        try {
          const response = await fetch(`/api/injuries/${injuryId}`);
          if (!response.ok) throw new Error("Could not fetch injury details.");
          const injury = await response.json();
          document.getElementById("injurySummary").innerHTML = `
            <p><strong>Injury Type:</strong> ${injury.InjuryType}</p>
            <p><strong>Location:</strong> ${injury.InjuryLocation}</p>
            <p><strong>Severity:</strong> ${injury.InjurySeverity}</p>
          `;
          document.getElementById("injuryId").value = injury.InjuryId;
        } catch (error) {
          console.error("Error loading injury:", error);
          document.getElementById("injurySummary").innerHTML = "<p>Error loading injury details.</p>";
        }
      }

      // Alternatively, if your API only supports fetching injuries by user_id,
      // you could fetch all and then filter for the specific injury.
      // async function fetchInjuryDetail() {
      //   const injuryId = getQueryParam("injury_id");
      //   const userId = getUserIdFromToken();
      //   if (!injuryId || !userId) return;
      //   try {
      //     const response = await fetch(`/api/injuries?user_id=${userId}`);
      //     const injuries = await response.json();
      //     const injury = injuries.find(i => i.InjuryId == injuryId);
      //     if (!injury) throw new Error("Injury not found.");
      //     document.getElementById("injurySummary").innerHTML = `
      //       <p><strong>Injury Type:</strong> ${injury.InjuryType}</p>
      //       <p><strong>Location:</strong> ${injury.InjuryLocation}</p>
      //       <p><strong>Severity:</strong> ${injury.InjurySeverity}</p>
      //     `;
      //     document.getElementById("injuryId").value = injury.InjuryId;
      //   } catch (error) {
      //     console.error("Error loading injury:", error);
      //     document.getElementById("injurySummary").innerHTML = "<p>Error loading injury details.</p>";
      //   }
      // }

      // Fetch journal entries for the user filtered by this injury
      async function fetchJournalEntries() {
        const userId = getUserIdFromToken();
        const injuryId = getQueryParam("injury_id");
        if (!userId || !injuryId) return;
        try {
          // Assuming your endpoint supports filtering by user_id,
          // you could also fetch all entries and then filter client-side.
          const response = await fetch(`/api/progress?user_id=${userId}`);
          const entries = await response.json();
          const container = document.getElementById('journalEntries');
          container.innerHTML = "";
          const filteredEntries = entries.filter(entry => entry.InjuryId == injuryId);
          if (!filteredEntries.length) {
            container.innerHTML = "<p>No journal entries found for this injury.</p>";
            return;
          }
          filteredEntries.forEach(entry => {
            const div = document.createElement('div');
            div.className = "journal-entry";
            div.innerHTML = `
              <p><strong>Pain Level:</strong> ${entry.PainLevel}</p>
              <p><strong>Mobility Level:</strong> ${entry.MobilityLevel}</p>
              <p><strong>Notes:</strong> ${entry.ProgressNotes || "None"}</p>
              <p><em>Recorded on: ${new Date(entry.RecordedAt).toLocaleString()}</em></p>
            `;
            container.appendChild(div);
          });
        } catch (err) {
          console.error("Error loading journal entries:", err);
        }
      }

      // Handle form submission to record a new journal entry
      document.getElementById('journalForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const userId = getUserIdFromToken();
        const injuryId = document.getElementById('injuryId').value;
        const painLevel = document.getElementById('painLevel').value;
        const mobilityLevel = document.getElementById('mobilityLevel').value;
        const progressNotes = document.getElementById('progressNotes').value;
        
        if (!injuryId) {
          document.getElementById('feedback').textContent = "Injury not set.";
          document.getElementById('feedback').style.color = "red";
          return;
        }
        
        const payload = {
          UserId: userId,
          InjuryId: injuryId,
          PainLevel: painLevel,
          MobilityLevel: mobilityLevel,
          ProgressNotes: progressNotes
        };

        const feedbackEl = document.getElementById('feedback');
        feedbackEl.textContent = "Submitting your journal entry...";
        feedbackEl.style.color = "black";

        try {
          const res = await fetch('/api/progress', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          });
          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error || "Failed to submit journal entry.");
          }
          feedbackEl.textContent = "Journal entry submitted successfully!";
          feedbackEl.style.color = "green";
          document.getElementById('journalForm').reset();
          // Reset slider display values
          document.getElementById('painDisplay').innerText = "5";
          document.getElementById('mobilityDisplay').innerText = "5";
          fetchJournalEntries();
        } catch (error) {
          feedbackEl.textContent = "Error: " + error.message;
          feedbackEl.style.color = "red";
        }
      });

      // On load, fetch the injury details and journal entries
      document.addEventListener('DOMContentLoaded', function() {
        fetchInjuryDetail();
        fetchJournalEntries();
      });
    </script>
  </body>
</html>
